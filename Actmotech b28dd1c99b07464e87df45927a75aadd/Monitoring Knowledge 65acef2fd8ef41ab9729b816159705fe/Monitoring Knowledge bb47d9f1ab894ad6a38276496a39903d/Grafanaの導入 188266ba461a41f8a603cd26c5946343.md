# Grafanaの導入

![grafana_logo_icon_171048.png](Grafana%E3%81%AE%E5%B0%8E%E5%85%A5%20188266ba461a41f8a603cd26c5946343/grafana_logo_icon_171048.png)

目次

# Grafanaとは

---

Grafana Labs社が開発したデータ可視化ツールとなります。

Grafanaを利用するためには元データが必要となり、PrometheusやZabbixなどと組み合わせて使います。

OSS版は無償利用が可能で、有償版のEnterpriseもあります。

主な違いはEnterprise向けにしか使えないデータソースのプラグインがあります。例：NewRelic

# Grafanaでできること

---

- 可視化

Dashboardを作成することで元データソースを可視化できます。

- アラート

元データソースから取得したものをアラート条件を用いてアラート通知することができます。

アラート通知にはメールの他にDiscord、Slack、PagerDutyなどにシステムに通知することができます。

- 複数のデータソース利用

同じグラフに異なる複数のデータソースを混合することで関連性のあるグラフを作成することができます。

- グループ毎に管理

Orgという機能で組織管理ができまるため、顧客A、顧客Bといった形でグループ管理することができます。

# Grafanaのインストール

---

インストールする環境はRokcyLinux9で実施します。

Grafanaのリポジトリを追加します。

```bash
# cat << EOF > /etc/yum.repos.d/grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
```

なお、RockyLinux9ではSHA-1アルゴリズムの仕様をポリシーで制限しています。

暗号署名を検証するためにSHA-1を仕様する場合は

以下コマンドでSHA-1のアルゴリズムを有効化します。

```bash
# update-crypto-policies --set DEFAULT:SHA1
```

AMPのデータソースにアクセスするためにgrafana.iniの設定を以下のようにします。

```bash
# Set to true to enable SigV4 authentication option for HTTP-based datasources.
sigv4_auth_enabled = true
domain = アクセスする際のIPアドレス or ドメイン名
```

Grafanaをインストールして、起動します。

```bash
# dnf -y install grafana
# systemctl enable --now grafana-server
```

http://IPアドレス:3000/loginでアクセスし、ID：admin、PASS：adminでログインします。

ログイン後にパスワードを任意のパスワードに変更します。

# GrafanaのUIでAMPのデータソースを追加

---

Data SourcesにPrometheusを追加します。

URLにAMPのエンドポイントのクエリURLを記載します。

AuthではSigV4 authをONにします。

事前に新規IAMユーザーを作成し、AmazonPrometheusQueryAccessポリシーをアタッチし、

Access & secret keyを払い出ししたAccess Key IDとSecret Access Keyを登録します。

![Untitled](Grafana%E3%81%AE%E5%B0%8E%E5%85%A5%20188266ba461a41f8a603cd26c5946343/Untitled.png)

# Grafana Dashboardのインポート

---

以下のDashboardをインポートします。

[Node Exporter Full | Grafana Labs](https://grafana.com/grafana/dashboards/1860-node-exporter-full/)

インポート後にDashboardが表示できれば設定完了です。

![Untitled](Grafana%E3%81%AE%E5%B0%8E%E5%85%A5%20188266ba461a41f8a603cd26c5946343/Untitled%201.png)

# GrafanaのHA化

---

Grafanaサーバをもう一台起動します。またGrafana2台が参照するDBが同じである必要があるため、PostgreSQLを作成します。

その後、grafana.iniの設定ファイルを編集します。

またGrafanaが複数台構成になるとGrafanaで設定したアラートルールがすべてのサーバでアラート評価されることになりアラート数が重複します。

その為、[本リンク](https://grafana.com/docs/grafana/latest/alerting/set-up/configure-high-availability/#enable-alerting-high-availability-using-memberlist)を参考にAlertの重複をしないようにします。

```jsx
#################################### Database ####################################
[database]
# You can configure the database connection by specifying type, host, name, user and password
# as separate properties or as on string using the url properties.
# Either "mysql", "postgres" or "sqlite3", it's your choice
type = postgres
host = PostgreSQLのサーバIP:5432
name = DBの名前
user = DBの接続ユーザー名
# If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
password = DB接続のパスワード

#################################### Unified Alerting ####################
[unified_alerting] 
#Enable the Unified Alerting sub-system and interface. When enabled we'll migrate all of your alert rules and notification channels to the new system. New alert rules will be created and your notification channels will be converted into an Alertmanager configuration. Previous data is preserved to enable backwards compatibility but new data is removed.```
enabled = true
# Listen address/hostname and port to receive unified alerting messages for other Grafana instances. The port is used for both TCP and UDP. It is assumed other Grafana instances are also running on the same port. The default value is `0.0.0.0:9094`.
ha_listen_address = "0.0.0.0:9094"
# Listen address/hostname and port to receive unified alerting messages for other Grafana instances. The port is used for both TCP and UDP. It is assumed other Grafana instances are also running on the same port. The default value is `0.0.0.0:9094`.
ha_advertise_address = "0.0.0.0:9094"
# Comma-separated list of initial instances (in a format of host:port) that will form the HA cluster. Configuring this setting will enable High Availability mode for alerting.
ha_peers = "Grafana1号機のIP:9094","Grafana2号機のIP:9094"
```