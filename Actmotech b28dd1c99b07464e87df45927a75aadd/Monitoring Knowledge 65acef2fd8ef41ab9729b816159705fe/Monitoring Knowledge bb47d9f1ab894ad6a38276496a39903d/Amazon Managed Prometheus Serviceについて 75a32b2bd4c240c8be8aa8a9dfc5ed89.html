<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Amazon Managed Prometheus Serviceについて</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-default_background {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-transparentGray { background-color: rgba(227, 226, 224, 0); }
.select-value-color-translucentGray { background-color: rgba(0, 0, 0, 0.06); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="75a32b2b-d4c2-40c8-be8a-a8a9dfc5ed89" class="page sans"><header><h1 class="page-title">Amazon Managed Prometheus Serviceについて</h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>タグ</th><td></td></tr></tbody></table></header><div class="page-body"><figure id="bc88e414-c396-490b-9cba-9d2d25265b08" class="image" style="text-align:left"><a href="Amazon%20Managed%20Prometheus%20Service%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%2075a32b2bd4c240c8be8aa8a9dfc5ed89/Managed_Service_for_Prometheus.png"><img style="width:240px" src="Amazon%20Managed%20Prometheus%20Service%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%2075a32b2bd4c240c8be8aa8a9dfc5ed89/Managed_Service_for_Prometheus.png"/></a></figure><h1 id="3aa14697-4b82-4e0c-9d9a-6d49caf6235f" class="">目次</h1><hr id="95e4cce5-f753-4910-bc88-60bc60fc0c41"/><nav id="d30deec8-1eeb-4bc1-9fe2-ccb471a93c45" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#3aa14697-4b82-4e0c-9d9a-6d49caf6235f">目次</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#94927d8f-1420-406d-bfc5-fa4a8d3eca34">Amazon Managed Prometheus Service(AMP)について</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#4d6f9a3f-0868-462e-8a7c-89a15ffb9615">PrometheusをAWS上に作成</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#4c455abd-3617-4a0f-ac81-08f6806a8751">AMPの設定</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#48035dda-9600-412d-8198-fc6cfd37d646">AMPに書き込み許可するIAM Policyを作成</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#ed94e446-3f3b-4c19-adc0-12691e9f5896">AMP RemoteStorageの設定</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d1f57967-6251-48d7-805a-b8a95a90ee2d">AWS上に作成したPrometheusから自宅k8sのPrometheusへフェデレーション</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#dfc3f406-6a2f-4f80-b705-3d3040faa0f6">AMPにPrometheusのデータを送信する際に、PrometheusをActive-Active構成にした場合</a></div></nav><h1 id="94927d8f-1420-406d-bfc5-fa4a8d3eca34" class="">Amazon Managed Prometheus Service(AMP)について</h1><hr id="c1b11658-15b2-411c-a4e8-803c8935ac3d"/><p id="b354f5f1-9dfd-48e3-8e6f-feb5ed873a73" class="">Prometheusは長期データ保存ができない設計となっております。</p><p id="0ad7e661-3ad0-43e0-832d-5affd33bd9f8" class="">長期で保存したい場合には別のストレージに書き出す必要があり、その中の一つとなるものです。</p><p id="c932ab5b-53c0-4bd7-843c-e2810cd2c7a9" class="">他にもストレージにはVictoriaMetricsが有名どころであるがナレッジがまだ少ないですね。</p><p id="ae8f2ab9-e6dd-4136-ab86-c79646961049" class="">選択できるストレージは以下に記載がありますので参考にしてみてください。</p><p id="8235dd1c-46c5-452f-ae0d-fe181b729799" class=""><a href="https://prometheus.io/docs/prometheus/latest/storage/">https://prometheus.io/docs/prometheus/latest/storage/</a></p><p id="113656f0-9994-46b2-a3cb-79db9e62eb64" class="">自身で調べた限りのAMPSの特徴は以下です。</p><ul id="38ba4603-4ee9-4bfe-9090-18b17d8e83a0" class="bulleted-list"><li style="list-style-type:disc">150日分のデータがデフォルトで保存可能だが申請することで150日以上保存が可能</li></ul><ul id="41f09987-968a-4be0-a833-2fd12e53e42a" class="bulleted-list"><li style="list-style-type:disc">SLAは99.9%</li></ul><ul id="1f050d28-35c5-4635-899d-cac1d3851173" class="bulleted-list"><li style="list-style-type:disc">オートスケールが可能で、3AZにまたがって冗長化されている</li></ul><ul id="d7801e37-a5a8-4b52-9306-4d8048328014" class="bulleted-list"><li style="list-style-type:disc">格納データからクエリを発行してSNS経由でアラート通知が可能（Alertmangerの代わりが可能かもしれない）</li></ul><ul id="b053b31c-b66f-4d70-a3cd-6ff9f16db09b" class="bulleted-list"><li style="list-style-type:disc">採用されている技術はCoretex</li></ul><p id="1d178a37-d4aa-4de7-b5f6-c0f0014b4b9b" class=""><a href="https://github.com/cortexproject/cortex">https://github.com/cortexproject/cortex</a></p><ul id="bf1b1fca-3044-4913-a745-cd2b4f3a7370" class="bulleted-list"><li style="list-style-type:disc">AWSが提供しているマネージドサービスのためストレージの運用管理が不要</li></ul><p id="161fca8c-9171-42ce-87d4-42735a6a8f92" class="">
</p><p id="0b3fed1a-cd7e-4341-9ad8-0351b66d5349" class="">これらの機能を踏まえて自宅にあるKubernetes環境で動いているPrometheusのデータをAMPSにリモートで書き込むには、</p><ol type="1" id="d5a19c1c-7e5a-47f7-b850-e49ee1012f03" class="numbered-list" start="1"><li>自宅k8sのPrometheusをソース元を絞って外部公開し、AWS上に立てたPrometheusにフェデレーションする</li></ol><ol type="1" id="7476f563-6d11-483a-b74c-dec61f68d0b2" class="numbered-list" start="2"><li>自宅ルータのFortigateとAWS Site to Site VPNを使ってIPSec接続し、AWS上に立てたPrometheusにフェデレーションする</li></ol><ol type="1" id="e5dd2446-b314-4178-afe4-a912dbe54a3d" class="numbered-list" start="3"><li>SSM Agentを利用してRemoteWriteを実現する</li></ol><p id="5ecd122d-d20f-4bcb-b0b7-3490a15e4d22" class="">
</p><p id="184b57cf-701b-40c8-be53-bc2eeeb274b3" class="">この中で簡単に実現かつセキュリティ的に安心できるのは2なのかなと思いますので、2で実現してみたいと思います。</p><p id="02bb4343-ed0e-4b65-ae92-4dd1df6057c7" class="">なお、金額についてですがAMPを東京リージョンで利用した場合、</p><p id="4ff7bb2b-12f4-4b35-abf4-d14b65a9ebb8" class="">PrometheusサーバとPrometheusサーバに仕込んだnode_exportのデータ1日の料金を、</p><p id="4d557b77-fe96-4287-9df2-0a851ebb69ea" class="">AWS Cost Exporterで確認したところ$0.73でした。</p><p id="409727db-1645-4934-af62-55652e6e2fbe" class="">これを1ヶ月を30日と考えた際に$21.9となり、1USDを130円とした時に約3000円になります。</p><h1 id="4d6f9a3f-0868-462e-8a7c-89a15ffb9615" class="">PrometheusをAWS上に作成</h1><hr id="2a032215-e5e0-46a0-98a4-06ca600b1133"/><p id="0dee5d12-36ff-4f78-894e-76c21253caee" class="">前提FortigateとSite to Site VPNの接続ができていること</p><figure id="6a143fc5-7a95-4520-9271-2545087a7b40" class="link-to-page"><a href="../../AWS%20Knowledge%204ff04ac2d7b44dc18b787d5954b927a0/Site%20to%20Site%20VPN%E3%81%A8Fortigate%E3%81%A6%E3%82%99IPSecVPN%206a143fc57a95452092712545087a7b40.html">Site to Site VPNとFortigateでIPSecVPN</a></figure><p id="90acfa9a-02a6-48ab-96be-2cda56366098" class="">Prometheus作成方法はOS直インストールする方法になりますが、以下を参照してPrometheusを作成してください。</p><figure id="2f963ebf-dbdb-4f6f-948e-37adbf830e84" class="link-to-page"><a href="Prometheus%E3%81%A8node_exporter%E3%81%AE%E5%B0%8E%E5%85%A5%202f963ebfdbdb4f6f948e37adbf830e84.html">Prometheusとnode_exporterの導入</a></figure><p id="c26466b7-5b8b-4574-8909-aeec43832d63" class="">EC2からAMPにRemoteWriteに接続するには以下を参考にしながら設定しました。</p><p id="f3f7f4db-84a1-445d-a94c-8537161d3d00" class=""><a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-ingest-metrics-remote-write-EC2.html">https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-ingest-metrics-remote-write-EC2.html</a></p><h1 id="4c455abd-3617-4a0f-ac81-08f6806a8751" class="">AMPの設定</h1><hr id="343f5086-37ad-498f-9498-163cf3440708"/><p id="13e6b47b-d852-4128-9302-cd38cd3bb050" class="">AWSコンソールにログインしてAMPのワークスペースを作成します。</p><p id="c83a285a-8035-48ee-a23a-c026a6b6c3b0" class="">作成ができたらリモート書き込みURLが発行されるので、URLを控えておきます。</p><h1 id="48035dda-9600-412d-8198-fc6cfd37d646" class="">AMPに書き込み許可するIAM Policyを作成</h1><hr id="2ab8bd1c-edbd-45de-9a10-8838c003d234"/><p id="0fb7d4fb-8848-4713-bcf3-8bd263835e1c" class="">必要なポリシーは「AmazonPrometheusRemoteWriteAccess」になります。</p><p id="15d9ff17-b8d4-40eb-b305-71884557e4a0" class="">ポリシーを作成したら、先ほどAWS上に作成したPrometheusにIAMロールを割り当てし、OS再起動します。</p><h1 id="ed94e446-3f3b-4c19-adc0-12691e9f5896" class="">AMP RemoteStorageの設定</h1><hr id="61d6f34a-529c-47e9-a9d4-0a1a4767af85"/><p id="41cf9b69-0ffa-4300-af51-7947c6737651" class="">/etc/prometheus/prometheus.ymlに以下を記載します。</p><p id="8b8d3227-6c0e-49a1-b801-3e1ea66024ec" class="">他にも設定できるパラメータは以下があります。</p><p id="1289da9f-3730-80ed-b361-d3d392ee824a" class=""><a href="https://prometheus.io/docs/practices/remote_write/">https://prometheus.io/docs/practices/remote_write/</a></p><ul id="ec7ef261-23bf-4050-a1e8-0790f8280d06" class="bulleted-list"><li style="list-style-type:disc">max_samples_per_send：<p id="8b5bad35-82cc-456e-a7c4-eb59189055b3" class="">一度に纏めて送信するサンプルの数</p><p id="d8401e39-e3ce-4fd7-9fbc-3d2962b7f6db" class="">キューに10000個サンプルがあり、設定値を1000にするとサンプルを1000個ずつに5回に分けて送信します。</p><p id="a847931b-d85f-4764-ad7b-69026e37841a" class="">送信されるタイミングはサンプルが1000個溜まった時点で外部ストレージに送信されます。</p></li></ul><ul id="a1603a7e-f591-4902-81a1-b447cfa7ebcc" class="bulleted-list"><li style="list-style-type:disc">max_shards：<p id="5804c258-ca95-4364-a9a8-8364daa928f9" class="">remote writeの並列実行数の上限</p><p id="ffe7303d-768e-42b0-abef-ff81dcee5d7a" class="">非常に遅いエンドポイントへのリモート書き込みでない限り、デフォルトを超えて増加する必要はほとんどないそうです。</p></li></ul><ul id="cd78283a-9fc5-4c9c-b965-9f9a2cefb518" class="bulleted-list"><li style="list-style-type:disc">capacity：<p id="4a54fbb6-bdde-4202-9659-cd1c8b08b5ce" class="">サンプルを格納できる最大容量</p><p id="acabc975-8e30-4090-a66c-2762dbf7e490" class="">スクレイピングで取得したサンプル数がcapacityを超えた場合、超えた分のサンプルは破棄されます。</p><p id="d1e182b2-fc6e-4479-8be1-a4b36fb22b4d" class="">例えば100のcapacityに対してスクレイピングしたサンプル数が130個となると、30個のサンプルが送信されず消失します。</p></li></ul><p id="c4cc4780-35ce-4853-af90-36c860a9ff92" class="">　　max_samples_per_sendの3から10倍に設定が推奨のようですが容量が多すぎるとメモリが過剰に消費されます。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8db4fd76-61d3-4f6e-b350-4cd0a4e3921e" class="code"><code class="language-Bash">remote_write:
  -
    url: https://aps-workspaces.ワークスペースを作成したリージョン.amazonaws.com/workspaces/ワークスペースID/api/v1/remote_write
    queue_config:
        max_samples_per_send: 1000
        max_shards: 200
        capacity: 2500
    sigv4:
         region: ワークスペースを作成したリージョン</code></pre><p id="dd26cb24-bc0b-4a31-bc9c-99ef47b0a2d6" class="">Prometheusのサービス再起動をします。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d4ef320a-d9d5-4ff0-a90e-648a5eb10e70" class="code"><code class="language-Bash"># systemctl restart prometheus
# systemctl status prometheus
→AMPのワークスペースと正常に接続できれていればログに表示されます。</code></pre><h1 id="d1f57967-6251-48d7-805a-b8a95a90ee2d" class="">AWS上に作成したPrometheusから自宅k8sのPrometheusへフェデレーション</h1><hr id="7c228caf-38b2-4a3f-bae8-c6e6fb7dc10f"/><p id="dc23917a-f1d8-4a9d-81d4-594aad4d8ae4" class="">k8s上のPrometheusをNodePortで外部公開できるようにします。</p><p id="28b03618-d6f4-4c7c-9a4f-9943cf19996d" class="">その後AWS上で作成したPrometheusから、k8s上のPrometheusの情報を全て取得するために、</p><p id="f16691c9-b219-4c3d-b1b7-9c7f7615b0c1" class="">/etc/prometheus/prometheus.ymlに以下のように追記します。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a700ad2e-1819-412e-a269-805a9924cd6f" class="code"><code class="language-Bash">- job_name: &#x27;federate&#x27;
    scrape_interval: 15s

    honor_labels: true
    metrics_path: &#x27;/federate&#x27;

    params:
      &#x27;match[]&#x27;:
        - &#x27;{job=&quot;.+&quot;}&#x27;
        - &#x27;{__name__=~&quot;.+&quot;}&#x27;

    static_configs:
      - targets:
        - &#x27;IPアドレス:30090&#x27;</code></pre><p id="1289da9f-3730-80ea-ab31-e48171c39144" class=""><a href="https://prometheus.io/docs/prometheus/latest/federation/">https://prometheus.io/docs/prometheus/latest/federation/</a></p><h1 id="dfc3f406-6a2f-4f80-b705-3d3040faa0f6" class="">AMPにPrometheusのデータを送信する際に、PrometheusをActive-Active構成にした場合</h1><hr id="dc4b4060-264b-4af1-b4c2-a3e8319f29ff"/><p id="42b1931e-c308-4040-9394-449d58df0234" class="">Prometheus自体にHA機能はありません。</p><p id="92b4dc4e-e8f8-48fd-a310-bd961d0cdd8d" class="">またHAの構成自体をPrometheusは否定をしておりActive-Activeで作るように展開している</p><p id="14163f14-83a1-48c6-b580-8f7e0ab20e2b" class="">ただActive-Activeで作るとメトリクスが重複してしまうので以下の機能を利用します。</p><p id="be6c1fce-091a-48dc-a7c4-e22532fce951" class="">Send high-availability data to Amazon Managed Service for Prometheus with Prometheus</p><p id="1289da9f-3730-801e-a77c-ca9a4f200d7c" class=""><a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-ingest-dedupe.html">https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-ingest-dedupe.html</a></p><p id="c9eee965-568d-4981-a61a-2670c08dd4a5" class="">/etc/prometheus/prometheus.ymlに以下を記載します。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5fdd28d0-9752-4f60-b163-4d43d0f3c896" class="code"><code class="language-Bash">## Prometheus01
global:
  external_labels:
      cluster: prometheus-cluster
      __replica__: ray-prometheus01

## Prometheus02
global:
  external_labels:
      cluster: prometheus-cluster
      __replica__: ray-prometheus02</code></pre><p id="ae45106a-abca-4baa-888a-2aa8a4199a9c" class="">Prometheusのサービス再起動をします。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4283c740-15e0-4fe3-9466-2f101a48b77e" class="code"><code class="language-Bash"># systemctl restart prometheus</code></pre><p id="b681ae33-3141-4558-a8b3-d6997c688878" class="">
</p><p id="59cd5daa-5cdf-4f4c-9537-c9ae9ba7641e" class="">
</p><p id="e4577afc-3aec-46f1-86ab-332d7381819f" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>