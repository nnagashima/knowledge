# Graylogを活用したログ分析

![ubuntu_14143.png](Guacamole%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B%2006607b0254a146f2926a6087ee4ab548/ubuntu_14143.png)

目次

# Graylogとは

---

ログデータ検索と保管にElasticsearchとOpenSearchを利用しています。

もともとrsyslogでログ保管をやっていましたがUIベースでみるものや検索のしやすなどログ分析ツールがないか探していたところ、

Graylogを見つけました。

Ubuntu22.04にインストールとセットアップしていきます。

# MongoDB6.xのインストール実施

---

```jsx
# apt-get install gnupg curl
# curl -fsSL https://pgp.mongodb.com/server-6.0.asc | \
   sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg \
   --dearmor
# echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
# apt update
# apt install mongodb-org -y
```

起動失敗

```jsx
# systemctl start mongod.service 
# systemctl status mongod.service 
× mongod.service - MongoDB Database Server
     Loaded: loaded (/lib/systemd/system/mongod.service; enabled; vendor preset: enabled)
     Active: failed (Result: core-dump) since Thu 2024-01-04 19:07:32 JST; 25s ago
       Docs: https://docs.mongodb.org/manual
    Process: 606 ExecStart=/usr/bin/mongod --config /etc/mongod.conf (code=dumped, signal=ILL)
   Main PID: 606 (code=dumped, signal=ILL)
        CPU: 10ms

 1月 04 19:07:32 graylog systemd[1]: Started MongoDB Database Server.
 1月 04 19:07:32 graylog systemd[1]: mongod.service: Main process exited, code=dumped, status=4/ILL
 1月 04 19:07:32 graylog systemd[1]: mongod.service: Failed with result 'core-dump'.

```

調べてみるとこんな記事を発見

ProxmoxのVMを作る際にプロセッサタイプをhostにする必要がある模様なので、一度OSを停止してプロセッサタイプを変更した上で起動

[https://chaloemphonthipkasorn.medium.com/mongodb-service-result-core-dump-in-proxmox-b2311c909b75](https://chaloemphonthipkasorn.medium.com/mongodb-service-result-core-dump-in-proxmox-b2311c909b75)

```jsx
# systemctl status mongod.service 
● mongod.service - MongoDB Database Server
     Loaded: loaded (/lib/systemd/system/mongod.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2024-01-04 19:10:49 JST; 32s ago
       Docs: https://docs.mongodb.org/manual
   Main PID: 592 (mongod)
     Memory: 137.8M
        CPU: 324ms
     CGroup: /system.slice/mongod.service
             └─592 /usr/bin/mongod --config /etc/mongod.conf

 1月 04 19:10:49 graylog systemd[1]: Started MongoDB Database Server.
 1月 04 19:10:50 graylog mongod[592]: {"t":{"$date":"2024-01-04T10:10:50.277Z"},"s":"I",  "c":"CONTROL",  "id":7484500, "ctx":"-","msg":"Environment variable MONGODB_C>
```

# OpenSearchインストールと設定を実施

---

```jsx
# curl -o- https://artifacts.opensearch.org/publickeys/opensearch.pgp | sudo apt-key add -
# echo "deb https://artifacts.opensearch.org/releases/bundle/opensearch/2.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/opensearch-2.x.list
# apt install opensearch -y
```

Graylogの設定でDemo設定はコメントアウトするが確認したところすでにコメントアウトされていたので何もしませんでした

```jsx
# vi /etc/opensearch/jvm.options
```

JVMの設定でVMのメモリを8GBで作成しているので4GB割り当てます

```jsx
# vi /etc/opensearch/jvm.options
-Xms4g
-Xmx4g
```

カーネルパラメータ設定

```jsx
# sysctl -w vm.max_map_count=262144
# echo 'vm.max_map_count=262144' >> /etc/sysctl.conf
```

OpenSearch起動

```jsx
systemctl daemon-reload
systemctl enable opensearch.service
systemctl start opensearch.service
systemctl status opensearch.service
```

# Elaticsearchインストールと設定を実施

---

```jsx
# wget -q https://artifacts.elastic.co/GPG-KEY-elasticsearch -O myKey
# apt-key add myKey
# echo "deb https://artifacts.elastic.co/packages/oss-7.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list
# apt update && sudo apt-get install elasticsearch-oss
```

クラスター名をGraylogに変更してElasticSearchを起動します。

```jsx
# tee -a /etc/elasticsearch/elasticsearch.yml > /dev/null <<EOT
cluster.name: graylog
action.auto_create_index: false
EOT

# systemctl enable elasticsearch
# systemctl start elasticsearch
```

# Graylogのインストールと設定を実施

---

```jsx
# wget https://packages.graylog2.org/repo/packages/graylog-5.0-repository_latest.deb
# dpkg -i graylog-5.0-repository_latest.deb
# apt update && sudo apt install graylog-server
```

Graylog セットアップと起動

```jsx
# apt install pwgen
# pwgen -N 1 -s 96
6tqjKc2SCE5mPUQLFA2HqeqyzGo1LEmgYz2W6rfWpRLdobGryM6bbNDQmzzahPWi7nDuRl1SfIVcLDutpBtVSALfA9Sw5OOS

# echo -n "Enter Password: " && head -1 </dev/stdin | tr -d '\n' | sha256sum | cut -d" " -f1
Enter Password: nncm3293
deea3f9cf10f2ffb2bbc47b1ba1a00282930c928d9bcd4eecde257078d048613

# vi /etc/graylog/server/server.conf
password_secret = 6tqjKc2SCE5mPUQLFA2HqeqyzGo1LEmgYz2W6rfWpRLdobGryM6bbNDQmzzahPWi7nDuRl1SfIVcLDutpBtVSALfA9Sw5OOS
root_password_sha2 = deea3f9cf10f2ffb2bbc47b1ba1a00282930c928d9bcd4eecde257078d048613
http_bind_address = 192.168.21.15:9000

# cat /etc/default/graylog-server 
GRAYLOG_SERVER_JAVA_OPTS="-Xms5g -Xmx5g -server -XX:+UseG1GC -XX:-OmitStackTraceInFastThrow"

# systemctl daemon-reload
# systemctl enable graylog-server.service
# systemctl start graylog-server.service

#以下で起動確認
# curl -X GET http://localhost:9200
{
  "name" : "graylog",
  "cluster_name" : "graylog",
  "cluster_uuid" : "DwQ_ENXRTY6RAu0ems-90w",
  "version" : {
    "number" : "7.10.2",
    "build_flavor" : "oss",
    "build_type" : "deb",
    "build_hash" : "747e1cc71def077253878a59143c1f785afa92b9",
    "build_date" : "2021-01-13T00:42:12.435326Z",
    "build_snapshot" : false,
    "lucene_version" : "8.7.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

最後にVMのGraylogに割り当てしたIPアドレスでアクセスを実施できればインストールと設定は完了となります。

# Graylogのログ受信設定

---

- Graylogにトップバ－のSystem -> Inputsを選択してクリック
- Inputs画面が表示されたら「Select input」のプルダウンリストより「Syslog UDP」を選び「Launch new input」をクリック
    - Globalにチェックを入れる
    - Titleに名前を入れる
    - Bind Addressに0.0.0.0を入れる
    - Portに1514を入れる
    
    上記入力完了後、保存をクリック
    
    あとはGraylogにログが転送されるようにログ送信先にて設定を実施してログが受信できていれば設定は完了です。