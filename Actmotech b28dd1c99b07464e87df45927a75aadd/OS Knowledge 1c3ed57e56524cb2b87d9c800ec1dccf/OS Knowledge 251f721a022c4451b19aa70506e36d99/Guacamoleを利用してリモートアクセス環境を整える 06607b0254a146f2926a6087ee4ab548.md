# Guacamoleを利用してリモートアクセス環境を整える

タグ: Ubuntu

![ubuntu_14143.png](Guacamole%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B%2006607b0254a146f2926a6087ee4ab548/ubuntu_14143.png)

目次

# はじめに

---

サーバ台数が増えてきて毎回ログインするのがめんどくさくなってきたので、 

Guacamoleを使ってサーバへログインすることにシフトしようと思ったのがきっかけです

# Guacamoleとは

---

正式にはApache Guacamoleといいます。 OSSで提供されておりWEBブラウザを用いて、遠隔にあるコンピュータへ接続できます。 

コロナ発生するまではVersionUpがあまりなされなかったのですが、 

コロナ渦の影響なのか需要が増えたようで急にバージョンアップが定期的に行われている印象があります。

機能としてはざっとですが以下が提供されています。 

・接続方法はSSHだけにとどまらず、RDPやTELNET、VNCなどにも対応しております。 

・操作ログを残せたりすることができるので、証跡をとることもできます。 

・ユーザー毎にアクセス可能なホストを制限することができます。

# Guacamoleのインストール

---

コンテナで利用したいので、UbuntuにDockerとDockerComposeをインストールします。

※インストールするコマンドだけ載せて略します。

```
# apt install apt-transport-https ca-certificates curl software-properties-common
# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
# apt update
# apt install docker-ce
# systemctl status docker
● docker.service - Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
     Active: active (running) since Tue 2021-04-27 13:30:29 UTC; 21s ago
# curl -L "https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
# chmod 755 /usr/local/bin/docker-compose
# docker-compose --version
docker-compose version 1.29.1, build c34c88b2
```

2023/02/02追記

RockyLinux9でのDockerインストールとDockerCompose v2のインストールを記載

```bash
# dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
# dnf install docker-ce
# docker --version
Docker version 20.10.23, build 7155243
# dnf install wget
# curl -s https://api.github.com/repos/docker/compose/releases/latest | grep browser_download_url  | grep docker-compose-linux-x86_64 | cut -d '"' -f 4 | wget -qi -
# chmod +x docker-compose-linux-x86_64
# mv docker-compose-linux-x86_64 /usr/local/bin/docker-compose
# docker-compose version
Docker Compose version v2.15.1
# systemctl enable docker
# systemctl start docker

```

DockerCompose用のGuacamoleが提供されているので、Gitからクローンして実行します。

```
# dnf install git
# git clone "https://github.com/boschkundendienst/guacamole-docker-compose.git"
# cd guacamole-docker-compose
# ./prepare.sh
# docker-compose up -d
# docker ps -a
CONTAINER ID   IMAGE                 COMMAND                  CREATED      STATUS                 PORTS                                             NAMES
629624519e9b   nginx                 "/docker-entrypoint.…"   9 days ago   Up 3 hours             80/tcp, 0.0.0.0:8443->443/tcp, :::8443->443/tcp   nginx_guacamole_compose
2700864131d5   guacamole/guacamole   "/opt/guacamole/bin/…"   9 days ago   Up 3 hours             0.0.0.0:49153->8080/tcp, :::49153->8080/tcp       guacamole_compose
6a96606f379e   postgres              "docker-entrypoint.s…"   9 days ago   Up 3 hours             5432/tcp                                          postgres_guacamole_compose
bfa0169dc988   guacamole/guacd       "/bin/sh -c '/usr/lo…"   9 days ago   Up 3 hours (healthy)   4822/tcp                                          guacd_compose
```

https://IPアドレス:8443 でアクセスし、以下TOP画面が表示されたら、

ID：guacadmin / PASS：guacadminでログインし、ログインが成功したら ユーザー作成やホスト登録を行ってください。

ホスト登録する際に証跡も残せるのですが私は/var/log/guaディレクトリにログファイル名を、

${GUAC_DATE}-${GUAC_TIME}_*接続先名-*${GUAC_USERNAME}.logとしています。

> ${GUAC_DATE}は、YYYYMMDDで表示されます
> 

> ${GUAC_TIME}は、HHMMSSで表示されます
> 

> ${GUAC_USERNAME}は、接続ユーザー名になります
> 

2023/02/02追記

Cloudflare経由の場合、CloudflareでSSL化できるため以下のように実施します。

```bash
# dnf install git
# git clone "https://github.com/boschkundendienst/guacamole-docker-compose.git"
# cd guacamole-docker-compose
# docker run --rm guacamole/guacamole /opt/guacamole/bin/initdb.sh --postgres > ./init/initdb.sql
# cat docker-compose.yml
version: '2.0'

# networks
# create a network 'guacnetwork_compose' in mode 'bridged'
networks:
  guacnetwork_compose:
    driver: bridge

# services
services:
  # guacd
  guacd:
    container_name: guacd_compose
    image: guacamole/guacd
    networks:
      guacnetwork_compose:
    restart: always
    volumes:
    - ./drive:/drive:rw
    - ./record:/record:rw
  # postgres
  postgres:
    container_name: postgres_guacamole_compose
    environment:
      PGDATA: /var/lib/postgresql/data/guacamole
      POSTGRES_DB: guacamole_db
      POSTGRES_PASSWORD: 'ChooseYourOwnPasswordHere1234'
      POSTGRES_USER: guacamole_user
    **image: postgres:12.3**
    networks:
      guacnetwork_compose:
    restart: always
    volumes:
    - ./init:/docker-entrypoint-initdb.d:z
    - ./data:/var/lib/postgresql/data:Z

  # guacamole
  guacamole:
    container_name: guacamole_compose
    depends_on:
    - guacd
    - postgres
    environment:
      GUACD_HOSTNAME: guacd
      POSTGRES_DATABASE: guacamole_db
      POSTGRES_HOSTNAME: postgres
      POSTGRES_PASSWORD: 'ChooseYourOwnPasswordHere1234'
      POSTGRES_USER: guacamole_user
    image: guacamole/guacamole
    links:
    - guacd
    networks:
      guacnetwork_compose:
    ports:
## enable next line if not using nginx
    **- 8080:8080/tcp # Guacamole is on :8080/guacamole, not /.**
## enable next line when using nginx
##    - 8080/tcp
    restart: always

# docker-compose up -d
# docker ps
CONTAINER ID   IMAGE                 COMMAND                  CREATED         STATUS                   PORTS                                       NAMES
f5c31ed8b6f3   guacamole/guacamole   "/opt/guacamole/bin/…"   5 minutes ago   Up 5 minutes             0.0.0.0:8080->8080/tcp, :::8080->8080/tcp   guacamole_compose
f5251ab67eaa   postgres:12.3         "docker-entrypoint.s…"   5 minutes ago   Up 5 minutes             5432/tcp                                    postgres_guacamole_compose
f2c8db48f5eb   guacamole/guacd       "/bin/sh -c '/usr/lo…"   5 minutes ago   Up 5 minutes (healthy)   4822/tcp                                    guacd_compose
```

https://Cloudflareで登録したドメインguacamole/#/でアクセスし、以下TOP画面が表示されたら、

ID：guacadmin / PASS：guacadminでログインし、ログインが成功したら ユーザー作成やホスト登録を行ってください。

なおRHEL9系よりSHA1が非推奨になったことにより、GuacamoleUIから自身に対してSSHしてもログインができませんでしたので、

以下コマンドを実行して回避をしています。※全体のセキュリティが緩くなるため他に方法ないか検討中です。

```bash
# update-crypto-policies --set LEGACY
```

2023/02/21追記

Apache Guacamole 1.5.0で Add support for ED25519 SSH keysとなったので、LEGACYにしなくても解決できそうです。

# 最後に

---

GucamoleはVer1.3からSAML認証にも対応しているようなのでOpenAMと組み合わせて、 

シングルサインオンもできるのではないかと思っているので、認証方法については勉強も兼ねてやってみたいと思います。

2023/02/02追記

上記で書いた通り、2要素認証を設定したので追記します。

docker-compose.ymlのguacamole欄を以下のようにします。

```bash
# guacamole
  guacamole:
    container_name: guacamole_compose
    depends_on:
    - guacd
    - postgres
    environment:
      GUACD_HOSTNAME: guacd
      POSTGRES_DATABASE: guacamole_db
      POSTGRES_HOSTNAME: postgres
      POSTGRES_PASSWORD: 'ChooseYourOwnPasswordHere1234'
      POSTGRES_USER: guacamole_user
      **GUACAMOLE_HOME: /etc/guacamole
    volumes:
      - ./guacamole:/etc/guacamole**
    image: guacamole/guacamole
    links:
    - guacd
    networks:
      guacnetwork_compose:
    ports:
## enable next line if not using nginx
    - 8080:8080/tcp # Guacamole is on :8080/guacamole, not /.
## enable next line when using nginx
##    - 8080/tcp
    restart: always
```

ディレクトリを作成し、以下からTOTPファイルをダウンロードして配置し、コンテナを再起動します。

```bash
# mkdir -p ./guacamole/extensions
# ls guacamole/extensions/
guacamole-auth-totp-1.4.0.jar

# docker-compose down && docker-compose up -d
```

[Apache Guacamole™](https://guacamole.apache.org/releases/1.4.0/)

起動後にGuacamoleにログインすると認証登録するためのQRコードが表示されるので、

GoogleAutheticatorで登録して表示された6桁のコードを登録し、ログインできれば登録完了です。

管理者のID：guacadmin以外のユーザを作成する際にはChange own passwordの権限を忘れないとTOTPが有効にならないので注意してください。