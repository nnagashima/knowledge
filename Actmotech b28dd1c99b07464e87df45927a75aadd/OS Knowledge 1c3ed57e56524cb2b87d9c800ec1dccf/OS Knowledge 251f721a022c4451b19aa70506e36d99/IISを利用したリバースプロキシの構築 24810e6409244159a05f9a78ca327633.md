# IISを利用したリバースプロキシの構築

![Windows_icon-icons.com_56585.png](../../AWS%20Knowledge%204ff04ac2d7b44dc18b787d5954b927a0/Onpremiss%20Active%20Directory%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6AWS%20ADConnector%E3%81%A8%E6%8E%A5%E7%B6%9A%204825963019724601b93adaba7ad1b8d2/Windows_icon-icons.com_56585.png)

目次

# はじめに

---

IISを利用したリバースプロキシの構築方法を記載します。

# IISのインストールとモジュールのインストール

---

サーバーマネージャーよりIISをインストールします。

IISのインストール後にURL Rewriteモジュールを以下からダウンロードしてインストールします。

[URL Rewrite : The Official Microsoft IIS Site](https://iis-umbraco.azurewebsites.net/downloads/microsoft/url-rewrite)

次にApplication Request Routingをインストールします。

[Application Request Routing : The Official Microsoft IIS Site](https://www.iis.net/downloads/microsoft/application-request-routing)

# IISのデフォルトウェブサイトでTestPageを作成

---

規定のドキュメントからindex.htmlを最上位に移動します。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled.png)

C:\inetpub\wwwroot配下にindex.htmlでテストページを作成します。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%201.png)

# HTTPSに対応するために自己証明書を作成

---

Powershellを使って自己署名証明書を作成します。(100年で作成しています。)

```jsx
New-SelfSignedCertificate -Subject "*.aws-actmotech.local" -DnsName "*.aws-actmotech.local" -CertStoreLocation "cert:\LocalMachine\My" -KeyAlgorithm RSA -KeyLength 2048 -KeyExportPolicy Exportable -NotAfter (Get-Date).AddYears(100)
```

コンピュータ証明書の管理を起動し、個人」→「証明書」フォルダをクリックします。

作成した証明書を選択して、右クリックで「コピー」を選択します。

[信頼されたルート証明機関]で［証明書］フォルダを右クリックで「貼り付け」を選択します。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%202.png)

PowerShellで作成した自己署名証明書をIISで使用するためにサイト編集のバインド（右メニュー一覧）をクリックします。

httpsでバインドを追加します。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%203.png)

テストページにアクセスします。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%204.png)

作成した自己証明書を他のサーバで利用したい場合などは、コンピュータ証明書の管理を起動し、個人」→「証明書」フォルダをクリックします。

作成した証明書を選択して、右クリックで「すべてのタスク」→「エクスポート」します。

※秘密キーもエクスポートしてください。

エクスポートする際にパスワード入力する必要があるので入力し、保存先に保存します。

保存したpfxファイルから以下コマンドを用いて秘密鍵と証明書ファイルをエクスポートします。

```jsx
# openssl pkcs12 -in aws-actmotech.local.pfx -nocerts -nodes -out aws-actmotech.local.key
# openssl pkcs12 -in aws-actmotech.local.pfx -clcerts -nokeys -out aws-actmotech.local.crt
```

# Application Request Routing Cacheの有効化

---

Application Request Routing Cacheをクリックします。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%205.png)

EnableProxyのチェックボックスにチェックを入れます。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%206.png)

# Rewrite機能でIISリバースプロキシの設定を実施

---

URL書き換えルールを作成します。

規則の追加で規則テンプレート内の受信規則からからの規則を選択してOKをクリックします。

作成するルール内容としては特定のホストヘッダーがあれば対象のURLにリダイレクト先に転送するをやりたいと思います。

- 名前を入力をします。
- 正規表現パターンとしては(.*)とします。
- 条件には入力に{HTTP_HOST}、種類にパターンに一致する、パターンにHTTPホストヘッダーの内容を記載します。
- アクション種類は書き換えにします。
- リダイレクト先のURLを記載します。(http://ドメイン名もしくはIPアドレス/{R:0})

# Webページにアクセス

---

アクセスするとバックエンドで用意したWEBサーバの画面が表示されて、かつHTTPSでアクセスができればOKです。

# IISのWebアクセスログの時刻表記修正

---

ログ記録のデフォルト形式はW3Cとなっており、UTC時刻で書き込みがされています。

IIS形式にすることでJST時刻に切り替えられます。

![Untitled](IIS%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AA%E3%83%8F%E3%82%99%E3%83%BC%E3%82%B9%E3%83%95%E3%82%9A%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AE%E6%A7%8B%E7%AF%89%2024810e6409244159a05f9a78ca327633/Untitled%207.png)

# IISのWebアクセスログのローテーション

---

IISのアクセスログは標準では削除する機能はありません。

タスクスケジューラーで以下コマンドが実行されるようにします。

以下の内容はログの位置が「C:\inetpub\logs\LogFiles」にあり、「90」日以前のログを削除する内容になります。

```jsx
forfiles /p “C:\inetpub\logs\LogFiles” /s /m *.* /c “cmd /c Del @path” /d -90
```