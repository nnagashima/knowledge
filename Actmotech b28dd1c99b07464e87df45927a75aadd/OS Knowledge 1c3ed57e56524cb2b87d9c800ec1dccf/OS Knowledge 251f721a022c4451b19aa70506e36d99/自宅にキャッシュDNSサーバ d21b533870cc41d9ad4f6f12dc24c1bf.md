# 自宅にキャッシュDNSサーバ

タグ: Ubuntu

![ubuntu_14143.png](Guacamole%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B%2006607b0254a146f2926a6087ee4ab548/ubuntu_14143.png)

目次

# はじめに

---

自宅にキャッシュDNSサーバがあればWebアクセス速度があがるかなと思ったので好奇心で作りました。

利用するものはunboundになります。

OSはUbuntu22.04を採用しています。

# Unboundとは

---

UnboundはDNSリゾルバ、キャッシュ、DNSSEC検証機能を持つDNSキャッシュサーバーです。次のような特徴を持ちます。

- DNSSEC対応
- DNSキャッシュ汚染に対する耐性が強い
- 設定が容易である（デフォルトで安全な設定ができる）
- 高性能
- IPv4、IPv6デュアルスタック

引用元：[https://unbound.jp/unbound/](https://unbound.jp/unbound/)

# Unboundのインストールと設定

---

Unboundのインストールを実施します。

```jsx
# apt install unbound
```

/etc/unbound/unbound.conf.d配下にunbound.confを作成します。

Unboundが動作するOSのIPアドレスは192.168.21.11になります。

```jsx
server:
    # listen interface
    interface: 192.168.21.11

    # listen network
    access-control: 192.168.11.0/24 allow
    access-control: 192.168.12.0/24 allow
    access-control: 192.168.21.0/24 allow

    # hide version
    hide-version: yes
    hide-identity: yes

    root-hints: root.hints

    do-ip6: no 

    use-syslog: no
    logfile: /var/log/unbound/unbound.log
    log-queries: yes
    log-time-ascii: yes
```

次に自身で解決できないものをGoogleDNSやCloudflareDNSに転送させます。

/etc/unbound/unbound.conf.d配下にforward.confを作成します。

```jsx
forward-zone:
    name: "."
    forward-addr: "8.8.8.8"
    forward-addr: "1.1.1.1"
```

DNSルートサーバの情報をダウンロードしてきます。

```jsx
# curl --output /etc/unbound/root.hints https://www.internic.net/domain/named.cache
```

UnboundのDNSクエリのログを保存するディレクトリを作成します。

```jsx
# mkdir /var/log/unbound
# chown unbound:unbound /var/log/unbound
```

作成したUnboundのConfに問題ないかチェックします。

```jsx
# unbound-checkconf 
unbound-checkconf: no errors in /etc/unbound/unbound.conf
```

systemd-resolvedのDNSスタブリゾルバとしての機能をオフにします。

```jsx
# vi /etc/systemd/resolved.conf
[Resolve]
DNSStubListener=no
```

systemd-resolvedの再起動

```jsx
# systemctl restart systemd-resolved
```

Unboundを起動します。

```jsx
# systemctl restart unbound.service
# systemctl status unbound.service
```

digコマンドでチェックして、ちゃんとAnswerが返答あるか確認します。

```jsx
$ dig www.google.com @192.168.21.11

; <<>> DiG 9.10.6 <<>> www.google.com @192.168.21.11
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32353
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;www.google.com.			IN	A

;; ANSWER SECTION:
www.google.com.		143	IN	A	142.251.42.132

;; Query time: 49 msec
;; SERVER: 192.168.21.11#53(192.168.21.11)
;; WHEN: Fri Dec 29 01:50:53 JST 2023
;; MSG SIZE  rcvd: 59
```

 ログはローテーションしたいので最後に/etc/logrotate.d/unboundファイルをつくります。

```jsx
/var/log/unbound/unbound.log
{
    daily
    dateext
    dateformat _%Y%m%d
    rotate 30
    missingok
    compress
    create 644 unbound unbound
    sharedscripts
    prerotate
        touch /var/log/unbound/unbound.log
        chown unbound:unbound /var/log/unbound/unbound.log
        chmod 644 /var/log/unbound/unbound.log
        /usr/sbin/unbound-control log_reopen
    endscript
    postrotate
        /usr/sbin/unbound-control log_reopen
    endscript
}
```

テストしてエラーがないことを確認します。

```jsx
# logrotate -dv /etc/logrotate.d/unbound
Handling 1 logs

rotating pattern: /var/log/unbound/unbound.log
 104857600 bytes (30 rotations)
empty log files are rotated, old logs are removed
considering log /var/log/unbound/unbound.log
Creating new state
  Now: 2023-12-29 11:14
  Last rotated at 2023-12-29 11:00
  log does not need rotating (log size is below the 'size' threshold)
not running prerotate script, since no logs will be rotated
not running postrotate script, since no logs were rotated
```

unboundのログ書き出しを/var/log/unbound/unbound.logにしておりましたがAppAmorが影響していましたので対処します。

```jsx
# vi /etc/apparmor.d/local/usr.sbin.unbound
/var/log/unbound/unbound.log rw,

# apparmor_parser -r /etc/apparmor.d/usr.sbin.unbound
# systemctl restart unbound.service
```

# Unboundに広告ブロッカー機能を追加

---

/etc/unbound/unbound.conf.d/unbound.confの最終行に以下を記載します。

以下ファイルは広告ブロッカーをダウンロードしたファイル名になります。

```jsx
include: /etc/unbound/adblock.conf
```

広告ブロッカーをダウンロードするスクリプトを作成します。広告ブロッカーは[StevenBlackのブロックリスト](https://github.com/StevenBlack/hosts)を利用します。

```jsx
#!/bin/bash

curl -s https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts | \
    grep ^0.0.0.0 - | \
    sed 's/ #.*$//;
    s/^0.0.0.0 \(.*\)/\1/' | \
    sudo tee /etc/unbound/adblock.txt > /dev/null

curl -s https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts | \
    grep ^0.0.0.0 - | \
    sed 's/ #.*$//;
    s/^0.0.0.0 \(.*\)/local-zone: "\1" refuse/' | \
    sudo tee /etc/unbound/adblock.conf > /dev/null

sudo systemctl restart unbound.service
```

定期的に広告ブロッカーをダウンロードするために、Cronジョブに追加します。

```jsx
# crontab -e
0 22 * * * /etc/unbound/get-ad-blocker.sh
```

# Unboundに広告ブロッカーリストとUnbound ログを比較してブロックリスト確認

---

adblock.txtとunbound.logを比較してブロックされたドメインを抽出するためのスクリプトを作成します。

```jsx
#!/bin/bash
ONE_DAY_AGO=$(date -d "1 day ago" +"%Y%m%d")
LOG_FILE="/var/log/unbound/unbound.log_$(date +"%Y%m%d").gz"
BLOCKED_DOMAINS_FILE="/etc/unbound/adblock.txt"
OUTPUT_LOG="/etc/unbound/blocked_domains/output_${ONE_DAY_AGO}.log"

# Read each line from the blocked domains file
while IFS= read -r domain; do
    # Check if the domain is found in the log file
    if zgrep -q "\<${domain}\>" "${LOG_FILE}"; then
        echo "Domain ${domain} is blocked." | tee -a "${OUTPUT_LOG}"
    fi
done < "${BLOCKED_DOMAINS_FILE}"
```

ブロックされたドメインを抽出するためのスクリプトをCronジョブを追加し、

ジョブ実行後に/etc/unbound/blocked_domains配下にoutputファイルが作成されたらOKです。

```jsx
# crontab -e
5 0 * * * /etc/unbound/blocked_domains.sh
```

# 最後に

---

DNSが1台だと不安なので、ここまで作成した状態で1度OSを停止して、クローンしてもう1台作りました。

興味本位で作りましたが自宅内のDNSアクセスログを追うことができるので、Blacklistドメインからの分析とかも面白そうです。