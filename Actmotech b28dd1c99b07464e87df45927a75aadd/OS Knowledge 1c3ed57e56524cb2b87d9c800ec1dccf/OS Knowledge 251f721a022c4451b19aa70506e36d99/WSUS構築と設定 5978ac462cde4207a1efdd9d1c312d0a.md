# WSUS構築と設定

![Windows_icon-icons.com_56585.png](../../AWS%20Knowledge%204ff04ac2d7b44dc18b787d5954b927a0/Onpremiss%20Active%20Directory%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6AWS%20ADConnector%E3%81%A8%E6%8E%A5%E7%B6%9A%204825963019724601b93adaba7ad1b8d2/Windows_icon-icons.com_56585.png)

目次

# WSUSとは

---

Windows Security Update  Serviceの略になります。

Microsoft社が提供するWindowsの更新プログラムをいったんWSUSサーバへダウンロードすることで、

各パソコンはそこから更新プログラムをダウンロードすることができます。

# WSUS機能の追加

---

作成したWindowsサーバでサーバマネージャーを開き、サーバの役割でWindows Security Update Serviceを選択します。

WSUSの役割とサービスで「WID Connectivity」と「WSUS Service」を選択します。

```jsx
※WID Connectivity
Windows Internal Database Connectivity. WSUSインストール時にインストールされるSQL Server Embedded Editionとその接続

※WSUS Service
Windows Security Update Service本体

※SQL Server Connectivity
WIDと別にSQLServerをインストールしてWSUS管理DBとする場合のConnectivity
```

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled.png)

コンテンツの場所の選択にて「次の場所に更新プログラムを配置します」に任意のディレクトリを指定して次に進みます。

WSUSのデータは大きくなりやすいので、可能であればCドライブとは別の場所に保管するようにした方がよいかと思います。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%201.png)

WSUSではIISも利用するので、IISもインストールされます。

IISの役割はデフォルトのまま次へ進みます。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%202.png)

最後にインストールボタンが表示されるので、インストールしていきます。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%203.png)

# WSUSの設定

---

インストールが完了するとサーバマネージャーのツールからWSUSがあるのでクリックして設定ウィーザードを起動します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%204.png)

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%205.png)

MicrosoftUpdateから同期するを選択します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%206.png)

インターネットに出る際にプロキシを利用している場合はプロキシ設定をいれます。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%207.png)

アップストリームサーバに接続にて接続の開始をクリックします。

ネットワーク環境によるかと思いますが、私の環境では約1時間かかりました。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%208.png)

言語の設定では必要な言語に加えて必ず英語を含めてください。

Microsoftの公式に以下のように記載されています。

```jsx
組織全体で必要な言語に加え、必ず英語を含めます。 すべての更新プログラムは英語の言語パックに基づいているためです。
参考URL：https://learn.microsoft.com/ja-jp/windows-server/administration/windows-server-update-services/plan/plan-your-wsus-deployment
```

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%209.png)

製品の選択ではWindowsServer 2019と2022が稼働している環境のため

「Microsoft Server Operationg System 21H2」

「Windows Server2019 and later,Servicing Drivers」「Windows Server 2019」

にチェックを入れます。

```jsx
Windows Server 2022 向けの更新プログラムを WSUSへ 同期するためには、同期対象に以下の “製品” を追加する必要があります。
製品「Microsoft Server operating system-21H2」
参考URL：https://jpmem.github.io/blog/wsus/2022-03-11_01/
```

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2010.png)

分類の選択では、ツール、ドライバーとドライバーセットを除くものにチェックをいれます。

特にドライバー関連はデータが多くWSUSの機能に影響を及ぼす可能性があるため除外しています。

| Feature Packs | 新しく公開された機能で、製品の次期リリースに含まれるような内容となります。 |
| --- | --- |
| Service Packs | これまでに作成されたすべてのホットフィックス、セキュリティ問題の修正プログラム、重要な更新、および更新をまとめたものと、製品の公開以後に内部で発見された不具合に対する修正が含まれます。Service Pack には、一部のお客様から要望された設計上の変更や機能が含まれることもあります。 |
| Upgrades | Windows 10 の機能更新プログラム (Feature Update) となります。 |
| セキュリティ問題の修正プログラム | セキュリティ上の脆弱性を修正するために、特定の製品に対して公開される修正プログラムです。「セキュリティのみの品質更新プログラム」や「セキュリティ マンスリー品質ロールアップ」も、この分類でリリースされております。 |
| ツール | あるタスク、または一連のタスクの実現を支援する、ユーティリティまたは機能です。 |
| ドライバ | ドライバーの更新となります。各ハードウェアベンダーにてWSUS に公開した更新が公開されております。 |
| ドライバーセット | 特定のモデルのコンピューターのハードウェアをサポートするドライバー郡となります。
Windows Server 2016 以降の WSUS でのみ、本分類は表示・選択できます。 |
| 更新 | 重要性が低く、セキュリティに関連しない不具合を修正するために、特定のプログラムに対して公開される修正プログラムです。「マンスリー品質ロールアップのプレビュー」もこの分類にてリリースされております。 |
| 修正プログラム集 | ホットフィックス、セキュリティ問題の修正プログラム、重要な更新、および更新を 1 つのパッケージにまとめ、展開したものです。修正プログラム集は通常、“セキュリティ”などの特定の分野、または “インターネット インフォメーション サービス (IIS)” などの製品のコンポーネントに対して用意されます。 |
| 重要な更新 | 重要性が高く、セキュリティに関連しない不具合を修正するために、特定の問題に対して公開される修正プログラムです。 |
| 定義更新プログラム | 製品の定義データベースへの追加を含む、広範かつ頻繁にリリースされるソフトウェア更新プログラムです。
定義データベースは、悪意のあるコード、フィッシングWebサイト、ジャンク電子メールなど、特定の属性を含むオブジェクトを検出するために、頻繁に使用されます。
Windows Defender や Office をお使いの場合に設定することが多いものとなります。 |

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2011.png)

同期のスケジュールではネットワークに負荷のかからない時間帯に同期をとるのがよいかと思います。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2012.png)

初回同期を実施するか問われているので、チェックを入れて初回同期を実施します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2013.png)

WSUSの管理コンソールが表示されて、同期の進行状況を確認します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2014.png)

WSUSのオプションをクリックし、コンピューターをクリックします。

コンピューターのグループポリシーまたはレジストリ設定を使用しますを選択して適用します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2015.png)

WindowsUpdateパッチは承認しないとクライアント端末に配布されないので、自動承認するように設定を変えます。

オプションの自動承認から新しい規則をクリックします。

更新が特定の分類に含まれる場合をクリックして、ツール、ドライバ、ドライバーセットを除くルールを作成します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2016.png)

サーバ系はServesのグループにまとめたいので、コンピューターの全てのコンピューターを右クリックしてグループを追加します。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2017.png)

# IISの設定

---

WSUSが利用するキャッシュメモリが既定値を超過すると、WSUSをホストするIISアプリケーション(WsusPool)がリサイクルする挙動するため、

自動リサイクルによるWSUS機能停止期間を発生させないためにも、WsusPoolのチューニングをMSのベストプラクティスに従って実施します。

参考URL：

[Windows Server Update Services (WSUS) のベスト プラクティス - Configuration Manager](https://learn.microsoft.com/ja-jp/troubleshoot/mem/configmgr/update-management/windows-server-update-services-best-practices)

IISの管理コンソールのアプリケーションプールからWsusPoolを選択して、右クリックで詳細設定を開き、以下項目を設定します。

| 設定名 | デフォルト値 | 設定値 |
| --- | --- | --- |
| プライベートメモリ制限（KB） | 1,843,200 | 0 |
| キューの長さ | 1,000 | 2,000 |
| アイドル タイムアウト (分) | 20 | 0 |
| Ping が有効になっている | True | False |
| 通常の時間間隔 (分) | 1740 | 0 |

# ウィルス対策ソフトを導入している場合

---

以下ディレクトリの除外が必要になります。

参考URL

[Design for Optimized Performance](https://learn.microsoft.com/ja-jp/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd939908(v=ws.10)#antivirus-scans)

- WSUSのデータフォルダ配下のWSUSContent
- WSUSのデータフォルダ配下のUpdateServicesDBFiles(MSSQLを利用している場合)
- C:\Windows\SoftwareDistribution\DataStore
- C:\Windows\SoftwareDistribution\Download

# WSUSを利用するGPOを作成

---

GPOの条件としてWindowsUpdateは自動でインストールまで実施したいですが、

自動インストールにしてしまうと任意のタイミングで自動でOS再起動がかかってしまいます。

そのためメンテナンスしてもよい時間帯にOS再起動がかかるようにセットアップします。

かつ、OS再起動はタスクスケジューラーで再起動するようにします。

| アクティブ時間ないの更新プログラムの自動再起動をオフにします。 | 有効
アクティブ時間開始：5AM
アクティブ時間開始：11PM |
| --- | --- |
| インターネット上のWindowsUpdateに接続しない | 有効 |
| イントラネットのMicrosoft更新サービスの場所を指定する | 有効
更新を検出するためのイントラネットの更新サービスを設定する：http://xxx.xxx.xxx.xxx:8530
イントラネット統計サーバーの設定：http://xxx.xxx.xxx.xxx:8530 |
| 自動更新を構成する | 4-自動ダウンロードしインストール日時を指定
自動メンテナンス時にインストールする：無効
インストールを実行する日：3-毎週火曜
インストールを実行する時間：06:00
毎週：有効 |
| クライアント側のターゲットを有効にする | 有効
コンピューターグループの名前：Servers |

こうすることでアクティブ時間帯はWindowsOSは再起動されません。

またアクティブ時間内でWindowsUpdateがWSUS経由で実施がされます。

この作成したGPOを対象のグループにリンクしてください。適用したGPOはOS再起動ないしはgpupdateコマンドで適用されます。

あとは22時頃にWindowsUpdateが終わっているだろうと考えて、22時にOS再起動されるようにタスクスケジューラーを設定してください。

ちゃんと動作確認も忘れずに！

# OSのパッチ適用状況確認

---

コンピューターを一覧で表示してパーセンテージを確認することで割り当てが問題ないか確認することができます。

※グループ化は後から実施しているので、あしからず。。。

![Untitled](WSUS%E6%A7%8B%E7%AF%89%E3%81%A8%E8%A8%AD%E5%AE%9A%205978ac462cde4207a1efdd9d1c312d0a/Untitled%2018.png)

# ドメインに属していないWindowsマシンもWSUSで管理したい場合は？？

---

Microsoftの記事にもありますが、ローカルポリシーを設定するもしくは、レジストリを直接いじることで可能となります。

[WSUS クライアントのグループ ポリシー:その 1 – 基本編](https://jpmem.github.io/blog/wsus/2019-04-16_01/)

# クリーンアップについて

---

定期的にクリーンアップを実施しないとディスク容量が逼迫します。

スクリプトをPowershellで作成し、タスクスケジューラーで毎日実行させます。

```jsx
▪️プログラム/スクリプト
%Systemroot%\System32\WindowsPowerShell\v1.0\powershell.exe

▪️引数の追加
-ExecutionPolicy Bypass WSUS-CleanUp.ps1の場所
```

WSUS-CleanUp.ps1

※プログラムを実行する前に必ず「New-EventLog -LogName Application -Source "WSUS Cleanup Task”」を実行してください。

```powershell
$message = "WSUSクリーンアップ処理を開始します。"

Write-EventLog -LogName System -Source "WSUS Cleanup Task" -EventID 65000 -EntryType INFORMATION -Message $message

try{
	$result = (Invoke-WsusServerCleanup -CompressUpdates -CleanupObsoleteUpdates -CleanupObsoleteComputers -CleanupUnneededContentFiles -DeclineExpiredUpdates -DeclineSupersededUpdates)
	if($result -ne $null){
		$message = "WSUSクリーンアップ処理が正常終了しました。`r`n`r`n"+$result
		Write-EventLog -LogName System -Source "WSUS Cleanup Task" -EventID 65001 -EntryType INFORMATION -Message $message
	}else{
		$message = "WSUSクリーンアップ処理が正常終了しましたが結果が空です。"
		Write-EventLog -LogName System -Source "WSUS Cleanup Task" -EventID 65002 -EntryType WARNING -Message $message
	}
}
catch{
	$message = $error[0].Exception.Message
	$message = "WSUSクリーンアップ処理がエラー終了しました。`r`n`r`n"+$message
	Write-EventLog -LogName System -Source "WSUS Cleanup Task" -EventID 65003 -EntryType ERROR -Message $message
}
```

# 最後に

そういえばWSUSが非推奨になりましたね。。。

今後はSaaSサービスやプロダクトを利用することも考えないといけないね。