# Cloudflareを利用して外部からアクセス

タグ: Ubuntu

![cloudflare_icon_146206.png](Cloudflare%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E5%A4%96%E9%83%A8%E3%81%8B%E3%82%89%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%207e564b12484f4c0593671fcff43cc83f/cloudflare_icon_146206.png)

目次

# はじめに

---

自宅で作ったものを外部公開する際や特定の場所からアクセスしたい時に、

リモートでアクセスする際はRouterなどの設定変更をしないといけません。

我が家ではNURO光を利用している回線があり二重ルータ構造となっているため設定は大変手間です。

そこで簡単に且つセキュリティ的にも安心できる方法を見つけたのでナレッジとして残します。

# Cloudflareとは

---

CDN、セキュリティサービス、DNSサービスなどを提供しています。

その中でも今回利用したいのはCloudflareが提供している、Cloudflare Tunnelを利用したく実施しております。

Cloudflare TunnelはRouterの設定など変更せずにドメイン経由でローカルで動ているものをインターネットに公開することができます。

また公開したものはちゃんとCloudflareのSSL証明書が適用されているのでhttpsでのアクセスも可能ですし、

制限をかけたい場合にはアクセスした際にEmailでの認証をつけたりすることも可能です。

上記を利用するにあたって今回Cloudflareとは別のところで取得したドメインのDNSサーバをCloudflareに切り替えしています。

※Freeプランで利用できます。

# DNSサーバの切り替え

---

1. 切り替え方法はWebsitesがAdd Siteをクリックしてドメインを入力します。
2. Freeプランを選択します。
3. CloudflareがDNSサーバにリクエストしてクエリを全て抜いてきてくれましたので内容問題なければ次に進みます
4. Cloudflareのネームサーバが表示されているので、ドメインを取得した管理画面にCloudflareのネームサーバに切り替えます。
5. 最後にセキュリティ設定があるので必要に応じてON/OFF設定をして、保存します。
6. ドメイン管理画面に戻り、Check nameserversをクリックし、レになっていれば完了です。

# Cloudflare Tunnelの利用

---

DNSサーバの切り替えが完了したので、ようやくやりたかったCloudflare Tunnelを設定します。

1. Cloudflare Zero TrustからAccess→Tunnelsをクリック
2. Create a tunnelをクリックしてトンネル名を任意名を入力
3. 公開したいサーバが動いている環境でCloudflareと接続するためにトンネルを張るためのインストールを実施
4. PublicHostnameをクリックして、サブドメインに任意の名前設定と先ほど登録したドメインを選択（Pathも指定したい場合はPathも入力）
5. Typeにはアクセスするプロトコルを選択し、URLにはLAN内でアクセスする際のURLを記載してSaveをクリック
6. 設定のTOPページに戻るのでHelthyが表示されていればOK

最後に設定したドメインでアクセスするとサーバのURLが表示可能になります。

なお証明書も自動的に発行されhttpsでの通信ができていることを確認できました。

# Cloudflare Tunnelを使うけどインターネットアクセスを制限したい！

---

1. 認証設定を入れたい場合にはCloudflare Zero TrustからAccess→Accessをクリック
2. Add an applicationをクリックし、Self Hostedをクリック
3. Application nameに任意名を入れて、サブドメインやドメインはCloudflare Tunnelの利用で記載した内容を登録し次に進む
4. Policy nameに任意の名前を入れて、Create additional rules欄にあるSelectorからEmailsを選択
5. Value欄に認証許可する際のメールアドレスを入力して次に進み、Add Applicationをクリックして完了です。

先ほど設定したドメインでアクセスするとメールアドレスでの認証画面が表示されるので、

登録したメールアドレスを入力し待っていると認証コードが届くので、認証コードを使ってログインすることが可能です。

これらを使うことで自宅でGuacamoleなど動かしていれば、リモート先から自宅サーバへのアクセスなどできるため便利ですよね。