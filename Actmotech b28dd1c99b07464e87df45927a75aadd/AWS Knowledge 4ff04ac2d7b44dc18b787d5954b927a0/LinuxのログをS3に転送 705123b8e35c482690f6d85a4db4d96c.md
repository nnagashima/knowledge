# LinuxのログをS3に転送

![amazon-s3-simple-storage-service.svg](Windows%E3%81%AE%E3%82%A4%E3%83%98%E3%82%99%E3%83%B3%E3%83%88%E3%83%AD%E3%82%AF%E3%82%99%E3%82%92S3%E3%81%AB%E8%BB%A2%E9%80%81%20120dbcb1ccbb4f4991cc69233f4e7d83/amazon-s3-simple-storage-service.svg)

# 目次

---

# はじめに

---

Linuxのログをローテーションして、ログをS3に退避する方法を記載します。

OSはRHELをベースに記載しています。

# EC2に適用するIAMロールとポリシーの作成

---

以下のようにIAMポリシーを作成して、EC2用のロールを作成しポリシーをアタッチします。

```jsx
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:PutBucketLogging",
                "s3:ListBucket"
            ],
            "Resource": "arn:aws:s3:::*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "s3:GetObjectVersionTorrent",
                "s3:PutObject",
                "s3:GetObjectAcl",
                "s3:GetObject",
                "s3:GetObjectVersionTagging",
                "s3:GetObjectVersionAcl",
                "s3:PutObjectVersionTagging",
                "s3:GetObjectTagging",
                "s3:PutObjectTagging",
                "s3:GetObjectVersionForReplication"
            ],
            "Resource": "arn:aws:s3:::*"
        },
        {
            "Sid": "VisualEditor2",
            "Effect": "Allow",
            "Action": "s3:ListAllMyBuckets",
            "Resource": "*"
        }
    ]
}
```

# EC2へAWS CLIをインストール

---

以下ドキュメントに従い、インストールを実施します。

https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-install.html

# EC2のログをローテションしつつ、S3へアップロード

---

例として/var/logにある拡張子のlogとつく名前のファイルをローテションします。

保存したいファイルの日付を増やしたい場合にはrotateの日数を伸ばしてください。

```jsx
/var/log/*.log {
    dateext
    missingok
    notifempty
    daily
    rotate 30
    sharedscripts
    compress
    su root root
    lastaction
        find /var/log/ -name "*log-`date +\"%Y%m%d.gz\"`" |xargs -L 1 -I % aws --region=ap-northeast-1 s3 cp % s3://【バケット名】/`curl http://169.254.169.254/latest/meta-data/instance-id/`/【ログファイル名】/
    endscript
} 
```